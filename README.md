# 基金净值及网格操作系统

一个基于Next.js开发的基金净值查询和网格交易策略系统，通过天天基金网API获取数据，并使用ECharts展示基金净值走势图和交易策略。支持基于日内高低点的网格交易回测，模拟真实交易环境中的T+1交易限制。

## 功能特点

- **基金搜索**：根据基金代码或名称搜索基金
- **基金详情**：显示基金的基本信息和涨幅数据
- **净值曲线**：自适应坐标轴的基金净值走势图，清晰展示基金净值变化
- **时间范围选择**：支持选择不同时间范围的净值数据（近1月、近3月、近6月、近1年、自定义）
- **基金操作记录**：记录用户的基金买入卖出操作，包含持有份额、市值和总计信息
- **ETF网格交易策略**：
  - 支持对称网格和单向下跌网格两种策略类型
  - 提供百分比模式和绝对金额模式两种网格设置方式
  - 卖出策略支持固定数量和动态比例两种模式
  - 支持小网格、中网格、大网格多重网格配置
  - 支持设置最大下跌幅度限制
  - 支持留存利润比例设置
  - 提供完整的回测功能和图表分析
- **日内高低点回测**：
  - 基于OHLC数据模拟日内价格波动
  - 模拟真实交易中条件单触发顺序
  - 支持在价格上涨/下跌过程中按实际路径触发网格点
  - 自动从API获取K线数据并缓存到数据库
- **T+1交易限制**：
  - 模拟证券市场T+1交易规则
  - 当日买入的份额次日才能卖出
  - 追踪可用份额和待解锁份额
  - 统计因T+1限制而未执行的交易次数
- **数据存储与优化**：
  - 支持Vercel Blob云存储和本地localStorage两种数据存储方式
  - K线数据智能缓存，避免重复获取相同日期范围的数据
  - 数据库和本地缓存双重优化

## 技术栈

- **前端框架**：Next.js 14
- **UI组件库**：Ant Design 5
- **图表库**：ECharts
- **样式方案**：Tailwind CSS
- **数据请求**：Axios
- **时间处理**：Day.js
- **数据存储**：Prisma + PostgreSQL / Vercel Blob / localStorage
- **部署平台**：Vercel

## 快速开始

确保已安装Node.js环境（推荐v18或更高版本）。

1. 先运行天天基金API服务

```bash
cd path/to/TiantianFundApi
npm install
npm start
```

2. 启动基金净值查询系统

```bash
cd fund-chart-app
npm install
npm run dev
```

3. 打开浏览器访问 [http://localhost:3000](http://localhost:3000)

## 使用说明

### 基本功能
1. 在搜索框中输入基金代码或名称进行搜索
2. 点击搜索结果选择需要查看的基金
3. 系统将自动加载并显示基金详情和净值走势图
4. 使用时间范围选择器可以查看不同时间段的净值数据

### 基金操作记录
1. 点击"基金操作"标签可以记录买入卖出操作
2. 每条记录都会显示操作类型、价格、份额、金额等信息
3. 表格底部会显示总计信息，包括总持有份额和市值

### ETF网格交易策略
1. 点击"ETF网格操作"标签可以设计网格交易策略
2. 选择策略类型（对称网格或单向下跌网格）
3. 选择网格模式（百分比模式或绝对金额模式）
4. 选择卖出策略（固定数量或动态比例）
5. 设置参考价格、网格数量和网格宽度
6. 可选择开启中网格和大网格，设置相应倍数
7. 点击"生成网格策略"生成详细的网格交易点位表
8. 点击"运行回测"可根据历史数据进行回测分析

### 日内高低点回测
1. 启用"使用日内高低点回测"开关
2. 选择回测时间范围
3. 点击"获取K线数据"按钮，系统会自动检查并获取所需数据
4. 点击"运行回测"按钮执行基于日内高低点的网格回测
5. 回测结果包含更详细的触发历史和T+1限制信息

### 回测结果分析
1. 查看回测图表，了解投资曲线和价值曲线变化
2. 查看回测摘要，包括总买入金额、总卖出金额、净投入金额、最大投入金额等指标
3. 查看交易记录，了解每笔交易的具体情况
4. 查看网格触发历史，了解每个交易日的价格变动和网格触发情况
5. 查看完整触发记录，包含所有网格点的触发状态
6. 导出回测数据，可选择包含策略参数、回测摘要、交易记录和网格触发历史

## 网格交易策略详解

### 策略类型
- **对称网格**：价格上涨时卖出，下跌时买入，适合震荡市场
- **单向下跌网格**：只在价格下跌时买入，适合单边下跌行情

### 网格模式
- **百分比模式**：以参考价格的百分比变动设置网格点位（例如：上下5%为一个网格）
- **绝对金额模式**：以价格的绝对变动值设置网格点位（例如：上下0.025元为一个网格）

### 卖出策略
- **固定数量**：根据对应买入网格点买入的份额按设定比例卖出
- **动态比例**：根据当前持仓和网格位置动态计算卖出比例

### 多重网格
- **小网格**：基本网格，适合小幅震荡
- **中网格**：中等网格，宽度和投资金额是小网格的倍数
- **大网格**：大幅网格，宽度和投资金额是小网格的倍数
- 三种网格可以同时启用，形成多层次网格策略

### 回测模式
- **基于净值的回测**：使用基金每日净值进行回测，适合长期策略评估
- **基于日内高低点的回测**：使用OHLC数据模拟日内价格波动，更贴近实际交易情况

### T+1交易限制
- 系统模拟证券市场T+1交易规则，当日买入的份额次日才能卖出
- 每日会统计可用份额和待解锁份额，确保回测结果符合实际交易规则
- 回测报告中会显示因T+1限制导致未执行的交易次数

## 数据存储优化

系统针对数据存储进行了多重优化：

1. **K线数据智能缓存**：
   - 检查本地已有数据是否满足回测需求
   - 查询数据库中是否已有所需数据
   - 只在必要时从外部API获取新数据

2. **批处理数据存储**：
   - 使用事务批量处理数据库操作
   - 动态调整批量大小，优化性能和稳定性

3. **兼容多种存储方式**：
   - 本地开发环境使用localStorage
   - 生产环境支持Vercel Blob云存储
   - 数据库使用Prisma + PostgreSQL

## API文档

系统使用天天基金网的API获取数据，主要包括：

- 基金搜索API
- 基金详情API
- 基金历史净值API
- 基金涨幅数据API
- K线数据API（新浪财经）

详细API文档请参考：[天天基金网API文档](https://kouchao.github.io/TiantianFundApi/)

## 环境变量配置

本应用支持在不同环境下部署，通过环境变量控制数据存储方式：

1. 在 Vercel 环境中运行时：
   - 使用 Vercel Blob 存储服务记录基金操作数据
   - 需要配置 `BLOB_READ_WRITE_TOKEN` 环境变量
   - 使用 Vercel Postgres 或其他数据库存储K线数据和回测结果
   - 需要配置数据库连接字符串
   
2. 在本地环境中运行时：
   - 默认使用浏览器 localStorage 存储操作数据
   - 使用本地数据库存储K线数据和回测结果
   - 不需要额外配置

### Vercel 环境配置

如果在 Vercel 上部署，请在 Vercel 项目设置中添加以下环境变量：

```
BLOB_READ_WRITE_TOKEN=你的Vercel Blob令牌
DATABASE_URL=你的数据库连接字符串
```

> 注意: 在 Vercel 平台部署时，请确保在 Vercel 项目的环境变量设置中添加这些变量，而不只是在 .env 文件中设置。

可以通过以下命令生成新的 Blob 令牌：

```bash
npx vercel blob generate-read-write-token
```

## 优化提示

- 在运行日内高低点回测时，避免选择过长的时间范围，以减少数据加载和处理时间
- 使用合理的网格数量和宽度，避免生成过多或过少的网格点
- 考虑T+1交易限制的影响，调整策略参数以适应实际交易规则
- 对于频繁使用的基金，数据会自动缓存到数据库中，提高后续查询速度

## 注意事项

- 本项目需要先启动天天基金API服务才能正常工作
- 默认API服务地址为`http://localhost:3000`，如有不同请修改`src/api/fund.ts`中的`API_BASE_URL`
- 净值图表已优化显示，坐标轴会根据数据范围自适应调整，并统一使用4位小数显示
- 网格交易策略中的场内基金交易按照100份整数倍进行委托计算
- 回测结果仅供参考，实际交易中可能存在滑点、成交量限制等因素影响
- Vercel免费账户有函数数量限制，如果部署失败，请检查是否超出限制 